{% extends "master.html" %}
{% load static %}

{% block title %}
  IP 控管主頁
{% endblock %}

{% block content %}
<div class="container">
    <div class="mt-4">
        <form action="/ip/overview">
            <input type="text" name="ip_query" placeholder="Search IP...">
            <input type="hidden" id="current_filter" name="current_filter" value="overview">
            <input type="submit" value="搜尋">
        </form>
    </div>
      
    <div class="mt-4 custom-nav-primary">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">所有 IP</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="iot-tab" data-bs-toggle="tab" data-bs-target="#iot" type="button" role="tab" aria-controls="iot" aria-selected="false">物聯網設備</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="nas-tab" data-bs-toggle="tab" data-bs-target="#nas" type="button" role="tab" aria-controls="nas" aria-selected="false">NAS</button>
            </li>
        </ul>
            <div class="tab-content text-light" id="myTabContent">
                <div class="tab-pane fade show active" id="overview" aria-controls="overview" role="tabpanel" aria-labelledby="overview-tab"></div>
                <div class="tab-pane fade" id="iot" aria-controls="iot" role="tabpanel" aria-labelledby="iot-tab"></div>
                <div class="tab-pane fade" id="nas" aria-controls="nas" role="tabpanel" aria-labelledby="nas-tab"></div>
            </div>
    </div>
</div>

<script>
var data = [];
const is_staff = {{ user.is_staff|lower }};

{% for item in results %}
        var obj = {
            "ip": "{{ item.ip }}",
            "service": "{{ item.service }}",
            "product": "{{ item.product }}",
            "os": "{{ item.os }}"
        };
        data.push(obj);
{% endfor %}

renderTable('overview', 'overview');
$('#current_filter').val('overview');

function filterData(criteria) {
    return data.filter(item => {
        // no column for iot
        if (criteria === 'iot') {
            return item.service === "印表機"
                || item.service === "攝影機";
        }
        else if(criteria === 'server'){
            return item.service === "伺服器主機";
        }
        else if(criteria === 'nas'){
            return item.service === "NAS";
        }
        else if (criteria === 'unknown') {
            return item.service === "待確認";
        }
        else if(criteria == 'overview') return true; // overview
        else return false;
    });
}

function renderTable(tabId, criteria) {
    const filteredData = filterData(criteria);
    var tableHtml = `<table class="table table-striped table-dark">
                        <thead>
                            <tr>
                            <th scope="col">IP</th>
                            <th scope="col">服務種類</th>
                            <th scope="col">軟體名稱</th>
                            <th scope="col">OS</th>`;
    if(is_staff === true){
        tableHtml += `<th scope="col">unix_like</th>
                      <th scope="col">owner</th>
                      </thead`;

    }
    else{
        tableHtml += `</thead>`;
    }
    tableHtml += `<tbody>
                    ${filteredData.map(item => `
                        <tr>
                            <td>${item.ip}</td>
                            <td>${item.service}</td>
                            <td>${item.product}</td>
                            <td>${item.os}</td>
                        </tr>`).join('')}
                  </tbody>
                </table>`
    $(`#${tabId}`).html(tableHtml);
}

$('.nav-link').on('click', function (e) {
    e.preventDefault();
    const tabId = $(this).attr('aria-controls');
    const criteria = $(this).attr('id').split('-')[0];
    $('#current_filter').val( $(this).attr('aria-controls'));
    renderTable(tabId, criteria);
});
</script>

{% endblock %}
